<?php

class Pet extends CI_Controller {

    /**
     * Index Page for this controller.
     *
     * Maps to the following URL
     * 		http://example.com/index.php/welcome
     * 	- or -  
     * 		http://example.com/index.php/welcome/index
     * 	- or -
     * Since this controller is set as the default controller in 
     * config/routes.php, it's displayed at http://example.com/
     *
     * So any other public methods not prefixed with an underscore will
     * map to /index.php/welcome/<method_name>
     * @see http://codeigniter.com/user_guide/general/urls.html
     */
    public function __construct() {
        parent::__construct();
        $this->load->model('Pet_model');
    }

    public function index() {
        $this->load->view('admin/index');
    }

    public function insert() {
        $this->load->view('admin/pet/insert/index');
        if (!empty($_POST['name'])) {
            $d_petdata['name'] = xss_clean($_POST['name']);
            $d_petdata['species'] = xss_clean($_POST['species']);
            $d_petdata['race'] = xss_clean($_POST['race']);
            $d_petdata['price'] = xss_clean($_POST['price']);
            $d_petdata['description'] = xss_clean($_POST['description']);
            $insert_id = $this->Pet_model->create($d_petdata);
            $baseurl = $this->config->config['base_url'];
            redirect("admin/pet/edit/" . $insert_id);
        }
    }

    public function display() {

//        with search query
        if(isset($_POST['search'])) {
            $search_term = xss_clean($_POST['search']);
            if($_POST['field']){
                $search_field = $_POST['field'];
                $this->db->like($search_field, $search_term);
            } else {
                $fields = array('name', 'species', 'race');
                foreach ($fields as $v_field) {
                    $this->db->or_like($v_field, $search_term);
                }
            }
        }
        
        $pets = $this->Pet_model->fetch();
        
        //get correct image for pet
        $this->load->model('gallery/image_model');
        foreach ($pets as $key => $v_pet) {
//            $image = $this->image_model->find_by_uuid($v_pet->image);
//            fb($image);
//            $pets[$key]->image 
        }

        $vw_displaydata = array('pets' => $pets);


        $this->load->view('admin/pet/display/index', $vw_displaydata);
    }

    public function delete($petID) {
        //confirmation
        if (isset($_POST['confirm']) && $_POST['confirm'] == 'yes') {
            $this->Pet_model->delete($petID);
            redirect('admin/pet/display/');
        } else {
            $pet = $this->Pet_model->find_by_id($petID);
            $vw_displaydata = array('pet' => $pet);
            $this->load->view('admin/pet/delete/index', $vw_displaydata);
        }
    }

    public function edit($petID) {
        if (isset($_POST['update'])) {
            
            $d_petdata = array();
            $d_petdata['name'] = xss_clean($_POST['name']);
            $d_petdata['species'] = xss_clean($_POST['species']);
            $d_petdata['race'] = xss_clean($_POST['race']);
            $d_petdata['price'] = xss_clean($_POST['price']);
            $d_petdata['description'] = xss_clean($_POST['description']);

            $this->Pet_model->update($d_petdata, $petID);
        }

        $pet = $this->Pet_model->find_by_id($petID);
        
        $this->load->model('gallery/image_model');
        $images = $this->image_model->get_images_by_album_id($pet->album);
        
        $vw_displaydata = array('pet' => $pet, 'images' => $images);
        $this->load->view('admin/pet/edit/index', $vw_displaydata);
    }
    
}

/* End of file welcome.php */
/* Location: ./application/controllers/welcome.php */